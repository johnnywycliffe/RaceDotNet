# Software
A high level description of all software in device, organized as a loose roadmap

## Normal operation
When not actively engaged in an activity, device shall show either the main menu or a "stats" screen.

The entire device will act as a state machine. 

### Main Menu
Main menu will display options one at a time, with arrows indicating up and down where appropriate. Submenus are accessed with right stick, and exited with left stick. Each entry on the menu will need the name, a link to the initiating function (through switch), knowledge of a submenu or supermenu to draw arrows, and the ability to be selected. 

Menu selection
- Point-to-Point
  - Pick location from saved
    - display list of locations
  - Pick location from phone
    - display list of locations
  - Pick location from recently used
    - display list of locations
- Drag
  - 1 Driver
  - 2 Driver
- Course
  - Setup
  - Run
- Sprint
  - Setup
  - Run
- Random location
- Stats
- Driver profile
  - View profile
  - Edit profile
  - Save/load profile
    - Save current
    - Load from SD
    - Load from Phone
  - Erase profile
- Options
  - Set units
    - Miles/km
    - 12 or 24 hour
  - Passive Data logging mode
  - Clear data
  - Password protect

### Input handler
A non-blocking selection tool needs to be present, that scans the potentiometer input from the joystick and button status when any selection is being made.

This is going to be used a lot, and cannot restrict input for other devices like the GPS or SD card reader.

- Use Joystick to control up, down, left & right
- Button 1 is select, Button 2 is back.

### Passive Data logging mode/logging screen
When data logging is on, records information to SD card even outside of a race. Can also display data to driver.

Data to display:
- Current velocity
- current coordinates
- current heading (NESW)
- distance traveled since device boot

Screen can be exited with button 2.

Pressing button 1 twice in two seconds will initiate police ping

### Driver profile
A small profile that allows each driver to identify others.

Required:
- Nametag
- Unique ID (Autogenerated)

Optional:
- Car Make
- Car Model
- Car Color
- Top speed acheived
- Fastest 0-60
- Fastest 1/4 mile
- Fastest 1000

Can choose not to share most details, but Nametag and UID must be shared for ranking purposes.

### Driver profile edit
Edit above information.

### Stat screen
Brings up a screen with the collected data. Average speed, calculate the top speed, stuff like that.

#### Standard stats
- Avg velocity
- Top speed
- Distance traveled

#### Race Stats
- Number of wins
- Number of races
- Avg participant count

#### Drag Stats
- Fastest 0-60
- Fastest 0-100
- Fastest 1/8 mile
- Speed at 1/8 mile
- Fastest 1/4 mile
- Speed at 1/4 mile
- Fastest 1000'
- Speed at 1000'

### Data transfer
Opens up a WiFi network to allow transfer of data. Probably going to be horribly slow.

Also should probably be able to view data via phone, not just copy it. Shows all the same data as above, and gives access to things like driver profile and options.

### Police ping
Broadcasts to all other drivers in range the location of the inititing driver. The other drivers are informed of the officer. Only available when driving, and not when in the main menu system.

When availble, press button 1 twice in two seconds. Pressing once will bring up "Do you really want to broadcast Police warning?"

The initiating driver will be recorded by all other cars that get the signal. This is to dissuade abuse of the system. Maybe need to add in some sort of arbitration.

### Password system
Once a password has been provided, the device cannot be used without logging in via phone or a password screen. Too many failed attempts will wipe the SD card, in case of sezure. 

Stored information probably needs to be at least slightly obfuscated to avoid casual inspection of the SD card.

### Checkpoints
Checkpoints have a default distance of about 25 feet. This means any GPS reading inside this will be accepted as having been at that location. This radius can be changed.

At high speeds, this may not be enough. GPS data is sampled at 10Hz, and a vehicle moving at ~100 MPH covers ~150 feet per second, so the GPS is sampling every 15 feet. If the vehicle travels off of the center of the circle, there is a chance that the Checkpoint could be skipped, which would suck.

To avoid this, if the **Direction to waypoint** is suddenly greater than 90 degrees between two readings, average out the readings and see if checkpoint is activated. This means driving off to the side of the checkpoint can still miss the checkpoint, but it won't be possible to undersample GPS data.

Similarly, for Drag racing, the start position is averaged during the setup phase to get as accurate as possible, then a sample is taken every tenth of a second. Once a measurement from >1/4 mile is taken, that last measurement is checked against the last measurement before 1/4 mile and math is done to find the actual 1/4 mile position.

## Events
Types of events a driver may initiate.

### Point-to-Point
Sends a location to all participating drivers, and keeps track of order of arrival. 

#### Description
First driver picks destination. Once destination is confirmed, broadcasts to all vehicles in vacinety. Includes start time, all devices should have same time with GPS clocks. Each driver is given the option to accept or opt out. Those who opt in are given set up time (screen shall read "Set up"), before LEDs turn red and the driver has to stop. Screen will switch to arrow mode. A start signal is given by the LEDs. False starts are recorded and penalties are applied. 

Once Arriving at destination, Signal is broadcast asking for scoreboard. If nobody is found, user is declared winner. Otherwise, request rank from leader. Exact arrival times are recorded in device for recordkeeping. Leader maintains a scoreboard until all participants check in or >67% of drivers have voted to close race (Someone drops out, crashes, pulled over, etc)

If there's only one driver, some of the code will skip since it doesn't make sense to 

#### High level
Initiating driver:
1. Obtain Coordinates 
  1. Load from SD
  2. Load from Cell Phone (WiFI/Bluetooth)
  3. Load from Recents
2. Choose start time
3. Choose setup time
4. Choose participation (Initiating driver may opt out, in case of camera car or event organizer)
5. Broadcast location and start time to other drivers.
6. Listen for Acks from other drivers until setup time initiates. Timer displayed on screen to indicate time until setup starts.
  - Timer may be cancelled, and will send cancellation to all other units in area.
7. During Setup time car is allowed to move. Timer is displayed, indicating time until cars must stop moving.
  - Timer can be cancelled on an individual car basis. Broadcasts "Backed out" to other drivers for scoreboard purposes.
8. LEDs turn Red, indicating race is about to start. Car must not move or will earn false start. False starts are broadcasted. Screen transitions to arrow.
9. LEDs turn Yellow, then Green to start race.
10. Move to "All drivers (While racing)"

Receiving driver(s):
1. Once message is received, ask driver to accept or reject event
  1. On reject, return to normal operation
  2. On accept, continue
2. Send join message back to Initiator informing of intent to join
3. Timer continues to count down until setup time.
  - Timer may be cancelled, and will send cancellation to Initiator. 
4. During Setup time car is allowed to move. Timer is displayed, indicating time until cars must stop moving.
  - Timer can be cancelled on an individual car basis. Broadcasts "Backed out" to other drivers for scoreboard purposes.
5. LEDs turn Red, indicating race is about to start. Car must not move or will earn false start. False starts are broadcasted. Screen transitions to arrow.
6. LEDs turn Yellow, then Green to start race.
7. Move to "All drivers (While racing)"

All drivers (While racing):
1. Get GPS coordinates
2. Compare with destination
  - If at destination, move to "On Arrival"
3. Obtain current heading.
4. Display heading and distance remaining on screen
5. Allow driver to abort, returning to normal mode. Broadcast "Backed out" message.

On Arrival:
1. Send message asking for scoreboard
  1. If no scoreboard received within "reasonable" time/attempts, move to "First arrival"
  2. Otherwise, receive scoreobard and move to "All following drivers"

First arrival:
1. Create scoreboard
2. Calculate any penalties assigned, and set as time.
3. Wait for messages from other drivers asking for scoreboard.
4. Update times on screen as more drivers roll in.
5. Listen for "end race" votes. If more than 67% of all drivers initially in race, close race down. "Backed out" drivers are removed from number.
6. Once all drivers accounted for or vote succeeds, send close race signal.
7. Save race data (Optional)
8. Return to normal operation.

All following drivers:
1. On receipt of scoreboard, copy.
2. Calculate own time, add penalties, broadcast. Include any "backed out" messages received, penalties noticed.
3. Display scoreboard.
4. Update scorboard as required.
5. Enable "End Race" button. Broadcast vote is selected.
6. When "End race" signal received, continue.
7. Save race data (Optional)
8. Return to normal operation.

#### Data saved to SD
1. Start location
2. End location
3. Each Participant ID and rank
4. Time
5. Penalties earned

### Drag
Allows one or two drivers to compete in a limited speed challenge.

#### Description
One or two people line up at a start line, and the device gives a countdown. For the next quarter mile, the drvier(s) go as fast as they can. Once the  1/4 mile is up, The device indicates to slow down.

Drags can be sent as a challenge to another driver, or letting the first respondant from the general vicinity apply.

Afterwards, data is processed to give the best representation of the Drag as possible.

#### High level
Initiating Driver:
1. Drag is initialized
2. Wait for confirmation from target driver or any other driver in the area.
3. Drivers are allowed to set up, pressing button 1 when ready.
4. After setup time is over, a random amount of time between 3-10 seconds is given to avoid anticipation.
5. A quick countedown using the LEDs is produced.
6. A false start is "awarded" if driver is in motion before go
7. Save every GPS signal, adding distance traveled (Not straight-line, but from point to point because real roads are curvy)
8. Once Distance is greater the 1/4 mile, signal drivers to slow down and stop.
9. Math is done to calculate all of the relevant data.
10. Data is show to driver, winner is displayed.
11. Data is saved.

#### Data saved to SD
1. Participants
2. All GPS data used to average the start of the drag
3. All GPS data during Drag.
4. Math results
5. Scores for each driver.

### Course
A full loop of a course, with checkpoints that must be hit. Can be multiple laps.

#### Description
There is two sub-modes to this program: Course builder, and Drive Course.

Course builder allows a driver to drive to checkpoints, selecting locations for checkpoints. They need to be made in order so the course has to be run, but there is no time being kept. These checkpoints are saved into memory, along with a course name. The checkpoints can be recalled at a later date. It  would also be great to be able to edit them

Once a pregenerated course is set up, a message is sent to all drivers in the area asking if they want to participate. If the answer is yes, the course is broadcast to all participants. Once each participant has received the course, there will be a short waiting period (adjustable) for all the cars to line up.

There will be a countdown and LEDs illuminated to indicate the start of the race. Once the light goes green, A timer starts for each driver. Once each driver crosses the start line, this data is saved. Another timer starts up. Each checkpoint-checkpoint and lap time is recorded. Once  required number of laps is completed, the drivers are given a rank.

If a course is run multiple times, times can be compared.

#### High level
Course generation:
1. Start generation
2. Until button 2 is pressed, continue to loop the following:
  1. Display coordinates of location and distance from previous checkpoint (first point is exception)
  2. Each time button 1 is pressed, add location as a checkpoint
  3. Checkpoint size maybe be adjusted. Minimum size is 15 feet, but 20-30 feet is recommended. 
3. Once course is set up, driver is asked to name course.
4. course is saved to SD.

Course editing:
1. Choose a course
2. Show checkpoints available and current radius
3. Once radius selected, can be adjusted with joystick. Button 1 saves, 2 exits without saving
4. Course can be renamed
5. Course is re-saved once complete

Initiating driver:
1. Driver picks course.
2. Course is sent to all drivers in area.
3. Wait for incoming signals from other drivers
4. Once signup period is over, setup begins
5. Line up behind start line
6. Wait for go and people to start moving in front of you

Other drivers:
1. Respond back affimative to initiating driver
2. Once signup period is over, setup begins
3. Line up behind start line
4. Wait for go and people to start moving in front of you

During event:
1. GPS arrow points towards next checkpoint, gives distance.
2. Records time to reach each checkpoint
3. check if a lap has been completed, and if so, if final lap is completed.

On finish:
1. Send message asking for scoreboard
  1. If no scoreboard received within "reasonable" time/attempts, move to "First to finish"
  2. Otherwise, receive scoreobard and move to "All following drivers"

First to finish:
1. Create scoreboard
2. Calculate any penalties assigned, and set as time.
3. Wait for messages from other drivers asking for scoreboard.
4. Update times on screen as more drivers roll in.
5. Listen for "end race" votes. If more than 90% of all drivers initially in race, close race down. "Backed out" drivers are removed from number.
6. Once all drivers accounted for or vote succeeds, send close race signal.
7. Save race data (Optional)
8. Return to normal operation.

All following drivers:
1. On receipt of scoreboard, copy.
2. Calculate own time, add penalties, broadcast. Include any "backed out" messages received, penalties noticed.
3. Display scoreboard.
4. Update scorboard as required.
5. Enable "End Race" button. Broadcast vote is selected.
6. When "End race" signal received, continue.
7. Save race data (Optional)
8. Return to normal operation.

#### Data saved to SD
1. Course (Checkpoints, size, name, number of laps)
2. Each Participant ID and rank
3. Lap times, checkpoint-checkpoint times
4. Best lap
5. Penalties earned

### Sprint
Sprints are Courses without looping an without laps. Predefined course with checkpoints, but one way.

#### Description
A sprint can be generated like a course, allowing for tweaking in the same manner.

The the only real difference is that it doesn't loop and there cannot be multiple laps.

Sprints can be run multiple times, and a driver can compare runs.

#### High level
Sprint generation:
1. Start generation
2. Until button 2 is pressed, continue to loop the following:
  1. Display coordinates of location and distance from previous checkpoint (first point is exception)
  2. Each time button 1 is pressed, add location as a checkpoint
  3. Checkpoint size maybe be adjusted. Minimum size is 15 feet, but 20-30 feet is recommended. 
3. Once Sprint is set up, driver is asked to name course.
4. Sprint is saved to SD.

Sprint editing:
1. Choose a Sprint
2. Show checkpoints available and current radius
3. Once radius selected, can be adjusted with joystick. Button 1 saves, 2 exits without saving
4. Sprint can be renamed
5. Sprint is re-saved once complete

Initiating driver:
1. Driver picks sprint
2. sprint is sent to all drivers in area.
3. Wait for incoming signals from other drivers
4. Once signup period is over, setup begins
5. Line up behind start line
6. Wait for go and people to start moving in front of you

Other drivers:
1. Respond back affimative to initiating driver
2. Once signup period is over, setup begins
3. Line up behind start line
4. Wait for go and people to start moving in front of you

During event:
1. GPS arrow points towards next checkpoint, gives distance.
2. Records time to reach each checkpoint
3. check if a lap has been completed, and if so, if final lap is completed.

On finish:
1. Send message asking for scoreboard
  1. If no scoreboard received within "reasonable" time/attempts, move to "First to finish"
  2. Otherwise, receive scoreobard and move to "All following drivers"

First to finish:
1. Create scoreboard
2. Calculate any penalties assigned, and set as time.
3. Wait for messages from other drivers asking for scoreboard.
4. Update times on screen as more drivers roll in.
5. Listen for "end race" votes. If more than 90% of all drivers initially in race, close race down. "Backed out" drivers are removed from number.
6. Once all drivers accounted for or vote succeeds, send close race signal.
7. Save race data (Optional)
8. Return to normal operation.

All following drivers:
1. On receipt of scoreboard, copy.
2. Calculate own time, add penalties, broadcast. Include any "backed out" messages received, penalties noticed.
3. Display scoreboard.
4. Update scorboard as required.
5. Enable "End Race" button. Broadcast vote is selected.
6. When "End race" signal received, continue.
7. Save race data (Optional)
8. Return to normal operation.

#### Data saved to SD
1. Sprint (Checkpoints, name)
2. Each Participant ID and rank
3. Time, checkpoint-checkpoint times
4. Penalties earned

### Random point
Picks a random location within a choosen distance, and the goal is to get there as fast as possible.

#### Description
Operates similarly to point-to-point, but the "endpoint" is picked at random. The maximum distance can be selected to avoid having to drive 100 miles as the crow flies. Random locations can also be vetoed before the round starts. Everyone can get the same location, or each can get their own.

Instead of an end point, the goal is to get the closest in the least amount of time. Pressing button 2 will save distance as closest acheived.

The return journey is not tracked, but does show GPS arrow back to origin.

Scores are compared, with every ten feet away from the checkpoint increasing the penalty.

#### High level
Initiating driver:
1. Device picks random location. Driver is encouraged to view and make sure it is accessable.
2. Choose start time
3. Choose setup time
4. Choose participation (Initiating driver may opt out, in case of camera car or event organizer)
5. Broadcast location and start time to other drivers.
6. Listen for Acks from other drivers until setup time initiates. Timer displayed on screen to indicate time until setup starts.
  - Timer may be cancelled, and will send cancellation to all other units in area.
7. During Setup time car is allowed to move. Timer is displayed, indicating time until cars must stop moving.
  - Timer can be cancelled on an individual car basis. Broadcasts "Backed out" to other drivers for scoreboard purposes.
8. LEDs turn Red, indicating race is about to start. Car must not move or will earn false start. False starts are broadcasted. Screen transitions to arrow.
9. LEDs turn Yellow, then Green to start race.
10. Move to "All drivers (While racing)"

Receiving driver(s):
1. Once message is received, ask driver to accept or reject event
  1. On reject, return to normal operation
  2. On accept, continue
2. Send join message back to Initiator informing of intent to join
3. Timer continues to count down until setup time.
  - Timer may be cancelled, and will send cancellation to Initiator. 
4. During Setup time car is allowed to move. Timer is displayed, indicating time until cars must stop moving.
  - Timer can be cancelled on an individual car basis. Broadcasts "Backed out" to other drivers for scoreboard purposes.
5. LEDs turn Red, indicating race is about to start. Car must not move or will earn false start. False starts are broadcasted. Screen transitions to arrow.
6. LEDs turn Yellow, then Green to start race.
7. Move to "All drivers (While racing)"

All drivers (While racing):
1. Get GPS coordinates
2. Compare with checkpoint
  - If button 2 is pressed, go to "Return"
3. Obtain current heading.
4. Display heading and distance remaining on screen
5. Allow driver to abort, returning to normal mode. Broadcast "Backed out" message.

Return:
1. Get GPS coordinates
2. Compare with initial position
  - If location match, move to "On Arrival"
3. Obtain current heading.
4. Display heading and distance remaining on screen
5. Allow driver to abort, returning to normal mode. Broadcast "Backed out" message.

On Arrival:
1. Send message asking for scoreboard
  1. If no scoreboard received within "reasonable" time/attempts, move to "First arrival"
  2. Otherwise, receive scoreobard and move to "All following drivers"

First arrival:
1. Create scoreboard
2. Calculate any penalties assigned, and set as time.
3. Wait for messages from other drivers asking for scoreboard.
4. Update times on screen as more drivers roll in.
5. Listen for "end race" votes. If more than 67% of all drivers initially in race, close race down. "Backed out" drivers are removed from number.
6. Once all drivers accounted for or vote succeeds, send close race signal.
7. Save race data (Optional)
8. Return to normal operation.

All following drivers:
1. On receipt of scoreboard, copy.
2. Calculate own time, add penalties, broadcast. Include any "backed out" messages received, penalties noticed.
3. Display scoreboard.
4. Update scorboard as required.
5. Enable "End Race" button. Broadcast vote is selected.
6. When "End race" signal received, continue.
7. Save race data (Optional)
8. Return to normal operation.

#### Data saved to SD
1. Start location
2. End location
3. Each Participant ID and rank
4. Time
5. Penalties earned

## Classes
A definition of some classes

### Driver profile

### Checkpoint
- Latitude
- Longitude
- ID
- Next Checkpoint (pointer?)
- CRC/hash check thing

### Scoreboard (Sprint, Course, Point-to-Point)
- Array of participant IDs
- Array of times
- Array of penalties
- If race was cancelled before all drivers arrived
- ID handed out at start of race - for arbitration after the fact.

### Sprint/Course
- Queue of checkpoints in order
- Name
- # of laps (0 or -1 for one-way)
- CRC/hash type function to make sure the files haven't been changed

### Drag Score
- Participant IDs
- Averaged starting position
- Calculated 1/4 mile
- 0-60 time
- 0-100 time
- 1/8 mile
- Speed at 1/8 mile
- 1/4 mile
- Speed at 1/4 mile
- 1000'
- Speed at 1000'
- Other driver's stats 

## Penalties
Can be saved as an 8 bit number. Bit shift them to be flags.

- False Start
- Bad Police Ping
- Missed Checkpoint
- Dropped out voluntarily
- Distance from target (random only)

Random will need to stare distance as a variables

## Main Functions
TODO

## Network scheme
TODO

## File scheme
TODO 

## Webapp
TODO

